{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "OrgName": {
      "type": "string",
      "minLength": 2,
      "metadata": {
        "description": "Name of the Company or Organization used for the Certificate Subject"
      }
    },
    "license": {
      "type": "string",
      "defaultValue": "trial",
      "metadata": {
        "description": "License Key for SCEPman"
      }
    },
    "updateChannel": {
      "type": "string",
      "defaultValue": "prod",
      "metadata": {
        "description": "Which Update Channel shall SCEPman use?"
      }
    },    
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated. Use the defaultValue if the staging location is not secured."
      },
      "defaultValue": ""
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located including a trailing '/'"
      },
      "defaultValue": "[deployment().properties.templateLink.uri]"
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Location where the resources will be deployed"
      }
    },
    "resourceTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags to be assigned to all created resources. Use JSON syntax, e.g. if you want to add tags env with value dev and project with value scepman, then write { \"env\":\"dev\", \"project\":\"scepman\"}."
      }
    }
  },
  "variables": {
    "artifactsRepositoryUrl": "[parameters('_artifactsLocation')]",
    "ArtifactsLocationSCEPman": "[uri(variables('artifactsRepositoryUrl'),concat('dist/Artifacts.zip', parameters('_artifactsLocationSasToken')))]",
    "ArtifactsLocationCertMaster":  "[uri(variables('artifactsRepositoryUrl'),concat('dist-certmaster/CertMaster-Artifacts.zip', parameters('_artifactsLocationSasToken')))]",
    "templateRepositoryUrl": "[parameters('_artifactsLocation')]",
    "appSvcTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/appSvcDouble.json', parameters('_artifactsLocationSasToken')))]",
    "logAnalyticsTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/loganalytics.json', parameters('_artifactsLocationSasToken')))]",
    "vaultTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/vault.json', parameters('_artifactsLocationSasToken')))]",
    "appConfigTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/appConfig-scepman.json', parameters('_artifactsLocationSasToken')))]",
    "appConfigCertMasterTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/appConfig-certmaster.json', parameters('_artifactsLocationSasToken')))]",
    "stgAccountTemplateUri": "[uri(variables('templateRepositoryUrl'), concat('nestedtemplates/stgAccount.json', parameters('_artifactsLocationSasToken')))]",
    "AppServicePlanName": "[concat('asp-scepman-',uniquestring(resourceGroup().id))]",
    "AppServiceName": "[concat('app-scepman-',uniquestring(resourceGroup().id))]",
    "AppServiceCertMasterName": "[concat('app-scepman-cm-',uniquestring(resourceGroup().id))]",
    "keyVaultName": "[concat('kv-scepman-',uniquestring(resourceGroup().id))]",
    "logAnalyticsWorkspaceName": "[concat('law-scepman-',uniquestring(resourceGroup().id))]",
    "storageAccountName": "[concat('stscepman',uniquestring(resourceGroup().id))]" 
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "pid-a262352f-52a9-4ed9-a9ba-6a2b2478d19b-partnercenter",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "SCEPmanAppServices",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('appSvcTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "AppServicePlanName": {
            "value": "[variables('AppServicePlanName')]"
          },
          "appServiceName": {
            "value": "[variables('AppServiceName')]"
          },
          "appServiceName2": {
            "value": "[variables('AppServiceCertMasterName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceTags": {
            "value": "[parameters('resourceTags')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "AzureMonitor",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('logAnalyticsTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "logAnalyticsAccountName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceTags": {
            "value": "[parameters('resourceTags')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "SCEPmanVault",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('vaultTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "permittedPrincipalId": {
            "value": "[reference('SCEPmanAppServices').outputs.scepmanPrincipalID.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceTags": {
            "value": "[parameters('resourceTags')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "DeploymentSCEPmanConfig",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('appConfigTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "StorageAccountTableUrl": {
            "value": "[reference('SCEPmanStorageAccount').outputs.storageAccountTableUrl.value]"
          },
          "appServiceName": {
            "value": "[variables('AppServiceName')]"
          },
          "scepManBaseURL": {
            "value": "[reference('SCEPmanAppServices').outputs.scepmanURL.value]"
          },          
          "keyVaultURL": {
            "value": "[reference('SCEPmanVault').outputs.keyVaultURL.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('AzureMonitor').outputs.workspaceId.value]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "OrgName": {
            "value": "[parameters('OrgName')]"
          },
          "WebsiteArtifactsUri": {
            "value": "[variables('ArtifactsLocationSCEPman')]"
          },
          "license": {
            "value": "[parameters('license')]"
          },
          "UpdateChannel": {
            "value": "[parameters('updateChannel')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "DeploymentCertMasterConfig",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('appConfigCertMasterTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServiceName": {
            "value": "[variables('AppServiceCertMasterName')]"
          },
          "scepmanUrl": {
            "value": "[reference('SCEPmanAppServices').outputs.scepmanURL.value]"
          },
          "StorageAccountTableUrl": {
            "value": "[reference('SCEPmanStorageAccount').outputs.storageAccountTableUrl.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('AzureMonitor').outputs.workspaceId.value]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "WebsiteArtifactsUri": {
            "value": "[variables('ArtifactsLocationCertMaster')]"
          },
          "UpdateChannel": {
            "value": "[parameters('updateChannel')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "SCEPmanStorageAccount",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('stgAccountTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "StorageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceTags": {
            "value": "[parameters('resourceTags')]"
          },
          "tableContributorPrincipals": {
            "value": [
              "[reference('SCEPmanAppServices').outputs.scepmanPrincipalID.value]",
              "[reference('SCEPmanAppServices').outputs.certmasterPrincipalID.value]"
            ]
          }
        }
      }
    }
  ]
}